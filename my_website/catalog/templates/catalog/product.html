{% extends 'base.html' %}
{% load catalog_tags %}

{% block content %}
<h1>{{ title }}</h1>

<!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
{% show_categories %}

<!-- –¢–µ–≥–∏ -->
{% show_tags %}

<!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–¥—É–∫—Ç–µ -->
<div class="product-detail">
    <div class="product-info">
        <h2>{{ product.name }}</h2>
        
        <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ -->
        {% if product.image %}
            <div class="product-image">
                <img src="{{ product.image.url }}" alt="{{ product.name }}" class="product-img">
            </div>
        {% endif %}
        
        <div class="product-price">
            {{ product.price }} —Ä—É–±.
        </div>
        
        <div class="product-description">
            <h3>–û–ø–∏—Å–∞–Ω–∏–µ:</h3>
            <p>{{ product.description|linebreaks }}</p>
        </div>
        
        <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞ -->
        {% if product.category %}
            <div class="product-category">
                <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</h3>
                <div class="tags-list">
                    <a href="{{ product.category.get_absolute_url }}" class="tag-link">{{ product.category.name }}</a>
                </div>
            </div>
        {% endif %}
        
        <!-- –¢–µ–≥–∏ –ø—Ä–æ–¥—É–∫—Ç–∞ -->
        {% if product.tags.all %}
            <div class="product-tags">
                <h3>–¢–µ–≥–∏:</h3>
                <div class="tags-list">
                    {% for tag in product.tags.all %}
                        <a href="{{ tag.get_absolute_url }}" class="tag-link">{{ tag.name }}</a>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
        
        <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ -->
        {% if product.detail %}
            <div class="product-details">
                <h3>–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:</h3>
                <div class="details-list">
                    {% if product.detail.size %}
                        <p><strong>–†–∞–∑–º–µ—Ä:</strong> {{ product.detail.size }}</p>
                    {% endif %}
                    {% if product.detail.material %}
                        <p><strong>–ú–∞—Ç–µ—Ä–∏–∞–ª:</strong> {{ product.detail.material }}</p>
                    {% endif %}
                    {% if product.detail.color %}
                        <p><strong>–¶–≤–µ—Ç:</strong> {{ product.detail.color }}</p>
                    {% endif %}
                    {% if product.detail.weight %}
                        <p><strong>–í–µ—Å:</strong> {{ product.detail.weight }} –∫–≥</p>
                    {% endif %}
                    {% if product.detail.manufacturer %}
                        <p><strong>–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å:</strong> {{ product.detail.manufacturer }}</p>
                    {% endif %}
                    {% if product.detail.country_origin %}
                        <p><strong>–°—Ç—Ä–∞–Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞:</strong> {{ product.detail.country_origin }}</p>
                    {% endif %}
                    {% if product.detail.production_year %}
                        <p><strong>–ì–æ–¥ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞:</strong> {{ product.detail.production_year }}</p>
                    {% endif %}
                    {% if product.detail.warranty_period %}
                        <p><strong>–ì–∞—Ä–∞–Ω—Ç–∏—è:</strong> {{ product.detail.warranty_period }}</p>
                    {% endif %}
                    {% if product.detail.sku %}
                        <p><strong>–ê—Ä—Ç–∏–∫—É–ª:</strong> {{ product.detail.sku }}</p>
                    {% endif %}
                    {% if product.detail.care_instructions %}
                        <p><strong>–£—Ö–æ–¥:</strong> {{ product.detail.care_instructions }}</p>
                    {% endif %}
                </div>
            </div>
        {% endif %}
        
        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="product-meta">
            <p>–î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: {{ product.created_at|date:"d.m.Y" }}</p>
            <p>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: {{ product.updated_at|date:"d.m.Y H:i" }}</p>
        </div>
        
        <!-- –†–µ–∞–∫—Ü–∏–∏ (–ª–∞–π–∫/–¥–∏–∑–ª–∞–π–∫) -->
        <div class="product-reactions">
            {% if user.is_authenticated %}
                <form method="post" action="{% url 'product_reaction' product.slug %}" class="reaction-form">
                    {% csrf_token %}
                    <input type="hidden" name="reaction_type" value="1">
                    <button type="submit" class="reaction-btn {% if user_reaction == 1 %}active{% endif %}">
                        üëç <span>{{ likes_count }}</span>
                    </button>
                </form>
                <form method="post" action="{% url 'product_reaction' product.slug %}" class="reaction-form">
                    {% csrf_token %}
                    <input type="hidden" name="reaction_type" value="-1">
                    <button type="submit" class="reaction-btn {% if user_reaction == -1 %}active{% endif %}">
                        üëé <span>{{ dislikes_count }}</span>
                    </button>
                </form>
            {% else %}
                <div class="reactions-login-prompt">
                    <a href="{% url 'users:login' %}?next={{ request.path }}" class="reaction-btn disabled">
                        üëç <span>{{ likes_count }}</span>
                    </a>
                    <a href="{% url 'users:login' %}?next={{ request.path }}" class="reaction-btn disabled">
                        üëé <span>{{ dislikes_count }}</span>
                    </a>
                    <p>–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ü–µ–Ω–∏—Ç—å —Ç–æ–≤–∞—Ä</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- –û—Ç–∑—ã–≤—ã -->
<div class="reviews-section">
    <h3>–û—Ç–∑—ã–≤—ã ({{ reviews_count }})</h3>
    
    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞ -->
    {% if user.is_authenticated %}
        {% if not user_has_review %}
            <div class="add-review-form">
                <h4>–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</h4>
                <form method="post" action="{% url 'add_review' product.slug %}">
                    {% csrf_token %}
                    <div class="form-group">
                        {{ review_form.rating.label_tag }}
                        {{ review_form.rating }}
                    </div>
                    <div class="form-group">
                        {{ review_form.text.label_tag }}
                        {{ review_form.text }}
                    </div>
                    {% if review_form.errors %}
                        <div class="form-errors">
                            {% for field, errors in review_form.errors.items %}
                                {% for error in errors %}
                                    <p class="error">{{ error }}</p>
                                {% endfor %}
                            {% endfor %}
                        </div>
                    {% endif %}
                    <button type="submit" class="btn-submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>
                </form>
            </div>
        {% else %}
            <p class="review-notice">–í—ã —É–∂–µ –æ—Å—Ç–∞–≤–∏–ª–∏ –æ—Ç–∑—ã–≤ –Ω–∞ —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä.</p>
        {% endif %}
    {% else %}
        <div class="login-prompt">
            <p>–ß—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ <a href="{% url 'users:login' %}?next={{ request.path }}">–≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</a>.</p>
        </div>
    {% endif %}
    
    <!-- –°–ø–∏—Å–æ–∫ –æ—Ç–∑—ã–≤–æ–≤ -->
    {% if reviews %}
        <div class="reviews-list">
            {% for review in reviews %}
                <div class="review-item">
                    <div class="review-header">
                        <strong>{{ review.user.username }}</strong>
                        <div class="review-rating">
                            {% for i in "12345" %}
                                {% if forloop.counter <= review.rating %}
                                    <span class="star filled">‚òÖ</span>
                                {% else %}
                                    <span class="star">‚òÜ</span>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <span class="review-date">{{ review.created_at|date:"d.m.Y H:i" }}</span>
                    </div>
                    <div class="review-text">
                        {{ review.text|linebreaks }}
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="no-reviews">–û—Ç–∑—ã–≤–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>
    {% endif %}
</div>

<!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
<div class="navigation">
    <a href="{% url 'catalog' %}">‚ùÆ –ù–∞–∑–∞–¥ –∫ –∫–∞—Ç–∞–ª–æ–≥—É</a>
    
    {% if product.category %}
        <a href="{{ product.category.get_absolute_url }}">‚ùÆ –ö –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ¬´{{ product.category.name }}¬ª</a>
    {% endif %}
    
    {% if perms.catalog.change_product %}
        <a href="{% url 'edit_product' product.slug %}" class="btn-edit">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä</a>
    {% endif %}
    {% if perms.catalog.delete_product %}
        <a href="{% url 'delete_product' product.slug %}" class="btn-delete">–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä</a>
    {% endif %}
</div>

{% endblock %}
